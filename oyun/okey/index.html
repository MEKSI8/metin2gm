<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Metin2 Okey Botu | Okey EtkinliÄŸi SimÃ¼lasyonu & AI</title>
    <meta name="description" content="Metin2 Okey EtkinliÄŸi iÃ§in en iyi yapay zeka botu. KartlarÄ± otomatik hesaplar, AltÄ±n SandÄ±k kazanma ÅŸansÄ±nÄ±zÄ± artÄ±rÄ±r. Ãœcretsiz okey simÃ¼lasyonu ve helper.">
    <meta name="keywords" content="metin2 okey botu, metin2 okey etkinliÄŸi, okey helper, metin2 okey simÃ¼lasyon, metin2 ai, okey kart seti, metin2 hile">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://seninsiten.com" />

    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9956375486231442"
     crossorigin="anonymous"></script>

    <style>
        :root { --mt2-gold: #ffcc00; --mt2-dark: #0b0f19; --mt2-panel: rgba(20, 25, 40, 0.95); }
        body { font-family: 'Cinzel', serif; background: radial-gradient(circle at center, #1a2035 0%, #000000 100%); color: #e2e8f0; touch-action: manipulation; user-select: none; }

        /* KART STÄ°LLERÄ° */
        .card {
            width: 55px; height: 80px; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Roboto Mono', monospace; font-weight: 900; font-size: 1.4rem;
            position: relative; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: all 0.2s;
            background: linear-gradient(135deg, #2d3748, #1a202c); border: 2px solid #4a5568;
        }
        .card::before { content: ''; position: absolute; inset: 2px; border: 1px dashed rgba(255,255,255,0.2); border-radius: 4px; }
        
        .card.y { border-color: #ecc94b; background: linear-gradient(145deg, #b7791f, #744210); color: #fffff0; text-shadow: 0 2px 0 #000; }
        .card.b { border-color: #4299e1; background: linear-gradient(145deg, #2b6cb0, #2c5282); color: #ebf8ff; text-shadow: 0 2px 0 #000; }
        .card.r { border-color: #f56565; background: linear-gradient(145deg, #c53030, #742a2a); color: #fff5f5; text-shadow: 0 2px 0 #000; }

        .card.selected { transform: translateY(-12px) scale(1.1); box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); z-index: 20; border-color: white; }
        
        /* AI Ã–NERÄ°LERÄ° */
        .card.suggest-discard { animation: pulse-red 1s infinite; border: 3px solid #ff3333 !important; transform: translateY(-15px) scale(1.15) !important; z-index: 50; }
        .card.suggest-keep { animation: pulse-green 1.5s infinite; border: 3px solid #33ff77 !important; transform: translateY(-8px) scale(1.05) !important; box-shadow: 0 0 15px rgba(51, 255, 119, 0.4); }
        
        .opacity-dim { opacity: 0.2; filter: grayscale(100%); transform: scale(0.95); transition: 0.3s; }
        .card.taken { opacity: 0.1; filter: grayscale(100%); pointer-events: none; }

        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } 50% { box-shadow: 0 0 20px rgba(255, 51, 51, 0.8); } }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(51, 255, 119, 0); } 50% { box-shadow: 0 0 20px rgba(51, 255, 119, 0.8); } }

        /* UI BÄ°LEÅENLERÄ° */
        .glass-panel { background: var(--mt2-panel); backdrop-filter: blur(12px); border: 1px solid rgba(255, 215, 0, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .gold-text { background: linear-gradient(to bottom, #ffd700, #ff8c00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8)); }

        .mt2-btn { background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%); border: 1px solid #4a5568; color: #cbd5e0; transition: 0.2s; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .mt2-btn:hover { border-color: #ffd700; color: #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .mt2-btn-primary { background: linear-gradient(180deg, #d69e2e 0%, #744210 100%); border: 1px solid #ffd700; color: #fff; text-shadow: 0 1px 2px black; }
        .mt2-btn-primary:hover { filter: brightness(1.2); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s; }
        .modal.show { opacity: 1; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 16px; width: 16px; 
            border-radius: 50%; background: #ffd700; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 0 10px #ffd700;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #4a5568; border-radius: 2px; }
        
        .toggle-checkbox:checked { right: 0; border-color: #ffd700; }
        .toggle-checkbox:checked + .toggle-label { background-color: #d69e2e; }
        
        .info-section { max-width: 800px; margin: 2rem auto; color: #94a3b8; font-size: 0.8rem; font-family: sans-serif; line-height: 1.6; }
        .info-section h2 { color: #ffd700; font-family: 'Cinzel', serif; font-size: 1.2rem; margin-bottom: 0.5rem; margin-top: 1.5rem; border-bottom: 1px solid #334155; padding-bottom: 0.2rem; }

        /* REKLAM ALANI STÄ°LÄ° */
        .ad-container {
            width: 100%; max-width: 728px; margin: 1rem auto;
            background: rgba(0,0,0,0.3); border: 1px dashed #334155;
            display: flex; justify-content: center; align-items: center;
            min-height: 90px; color: #475569; font-size: 0.75rem;
            border-radius: 8px; overflow: hidden;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-3 pb-8">

    <div class="ad-container">
        <span class="opacity-50">REKLAM ALANI</span>
    </div>

    <header class="w-full max-w-lg flex flex-col gap-3 mb-4 sticky top-2 z-40 glass-panel p-3 rounded-xl">
        <div class="flex justify-center items-center mb-2">
            <svg width="180" height="40" viewBox="0 0 180 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 20L20 5H30L20 20L30 35H20L10 20Z" fill="#ffcc00" stroke="#b7791f" stroke-width="2"/>
                <path d="M25 20L35 5H45L35 20L45 35H35L25 20Z" fill="#1a202c" stroke="#ffcc00" stroke-width="2"/>
                
                <text x="55" y="28" font-family="'Cinzel', serif" font-weight="bold" font-size="22" fill="#e2e8f0" letter-spacing="2">
                    METIN2<tspan fill="#ffcc00">AI</tspan>
                </text>
            </svg>
        </div>
        
        <div class="flex justify-between items-center px-2">
            <div class="text-center">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">SKOR</div>
                <div class="text-2xl font-bold gold-text" id="scoreDisplay">0</div>
            </div>
            <div class="flex gap-2">
                <button onclick="openSimModal()" class="mt2-btn px-4 py-2 rounded font-bold">âš”ï¸ SimÃ¼le Et</button>
                <button onclick="resetGameUI()" class="mt2-btn px-3 py-2 rounded text-lg">ğŸ”„</button>
            </div>
            <div class="text-center">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">KARTLAR</div>
                <div class="text-2xl font-bold text-blue-400 drop-shadow-md" id="deckDisplay">24</div>
            </div>
        </div>
        <div class="h-px bg-slate-700/50 w-full"></div>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-800/50 p-2 rounded border border-slate-700">
                <div class="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                    <span>Yapay Zeka GÃ¼cÃ¼</span>
                    <span id="mctsValue" class="text-yellow-500">REFLEKS (0)</span>
                </div>
                <input type="range" id="mctsSlider" min="0" max="150" value="0" step="10" class="w-full">
            </div>
            <div class="bg-slate-800/50 p-2 rounded border border-slate-700 flex items-center justify-between px-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase">OTO OYNA</span>
                <div class="relative inline-block w-10 align-middle select-none">
                    <input type="checkbox" name="toggle" id="autoDrawToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300"/>
                    <label for="autoDrawToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer transition-colors duration-300"></label>
                </div>
            </div>
        </div>
    </header>

    <div id="aiPanel" class="w-full max-w-lg glass-panel p-4 mb-4 rounded-xl hidden border-l-4 border-l-yellow-500 transition-all duration-300">
        <div class="flex items-center gap-4">
            <div class="text-4xl filter drop-shadow-lg">ğŸ”®</div>
            <div class="flex-grow">
                <h2 class="text-sm font-bold text-yellow-400 uppercase tracking-wider" id="aiTitle">Yapay Zeka HazÄ±r</h2>
                <p class="text-xs text-slate-300 mt-1" id="aiDesc">Hamle bekleniyor...</p>
                <p class="text-[10px] font-mono text-blue-300 mt-1" id="aiDetails"></p>
            </div>
        </div>
        <button id="executeBtn" class="w-full mt-3 py-3 mt2-btn-primary rounded font-bold text-sm shadow-lg tracking-widest transition-transform active:scale-95">
            HAMLEYÄ° UYGULA
        </button>
    </div>

    <div class="w-full max-w-lg flex-grow flex flex-col justify-center">
        <div class="glass-panel rounded-xl p-6 min-h-[160px] flex justify-center items-center relative">
            <div class="absolute inset-0 flex justify-center items-center opacity-5 pointer-events-none">
                <svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/></svg>
            </div>
            <div id="myHand" class="flex justify-center gap-3 flex-wrap w-full z-10">
                <button id="startGameBtn" onclick="openPicker(5)" class="mt2-btn-primary px-8 py-4 rounded-lg font-bold text-white shadow-xl animate-pulse tracking-widest">
                    ğŸ¤š OYUNU BAÅLAT
                </button>
            </div>
        </div>
    </div>

    <div class="ad-container">
        <span class="opacity-50">REKLAM ALANI</span>
    </div>

    <div class="info-section px-4 pb-10">
        <h2>Metin2 Okey Botu Nedir?</h2>
        <p>
            Metin2 Okey EtkinliÄŸi, oyuncularÄ±n AltÄ±n, GÃ¼mÃ¼ÅŸ ve Bronz sandÄ±k kazanmak iÃ§in yarÄ±ÅŸtÄ±ÄŸÄ± stratejik bir kart oyunudur. 
            Bu <strong>Okey Botu</strong>, en iyi hamleleri hesaplamak iÃ§in AlphaZero yapay zeka teknolojisini kullanÄ±r. 
            90000 Ã¼zerinde simÃ¼lasyonla eÄŸitilen bu AI, elinizdeki ve destedeki kartlara gÃ¶re en yÃ¼ksek puanÄ± almanÄ±zÄ± saÄŸlar.
        </p>

        <h2>Bot NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h2>
        <p>
            Sistem tamamen tarayÄ±cÄ±nÄ±zda Ã§alÄ±ÅŸÄ±r . <strong>ONNX Runtime</strong> kullanÄ±larak Python'da eÄŸitilen model, web ortamÄ±na aktarÄ±lmÄ±ÅŸtÄ±r.
            <strong>MCTS (Monte Carlo Tree Search)</strong> algoritmasÄ± sayesinde yapay zeka, 50-100 hamle sonrasÄ±nÄ± simÃ¼le eder ve risk analizi yapar. 
            "Zeka GÃ¼cÃ¼" ayarÄ±nÄ± artÄ±rarak botun dÃ¼ÅŸÃ¼nme kapasitesini yÃ¼kseltebilirsiniz. DÃ¼ÅŸÃ¼nme sayÄ±sÄ±nÄ± ne kadar yÃ¼kseltirseniz o kadar yavaÅŸ oynayacaktÄ±r.
        </p>

        <h2>GÃ¼ncellemeler</h2>
        <p>
            <strong>v2.1 Yenilikleri:</strong> Kademeli Ã¶dÃ¼l sistemi entegrasyonu, oyun sonu hata dÃ¼zeltmeleri ve mobil uyumlu arayÃ¼z. 
            Yapay zeka artÄ±k "GÃ¼mÃ¼ÅŸ SandÄ±k" tuzaÄŸÄ±na dÃ¼ÅŸmemek iÃ§in 400 puan (AltÄ±n SandÄ±k) hedefine agresif oynuyor. Her yeni gÃ¼n daha Ã§ok eÄŸitilmiÅŸ zeka ile gÃ¼ncelleniyor.
        </p>
    </div>

    <div id="pickerModal" class="modal">
        <div class="glass-panel p-5 rounded-xl w-full max-w-sm m-4 border border-slate-600 shadow-2xl transform scale-100 transition-transform">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700">
                <h3 class="font-bold text-yellow-500 tracking-widest" id="pickerTitle">KART SEÃ‡Ä°MÄ°</h3>
                <button onclick="closeModal('pickerModal')" class="text-xs text-red-400 hover:text-red-300 font-bold px-2 py-1 border border-red-900 rounded bg-red-900/20">Ä°PTAL âœ•</button>
            </div>
            <div class="grid grid-cols-8 gap-2 overflow-y-auto p-2 max-h-[60vh]" id="pickerGrid"></div>
            <div class="mt-4 pt-2">
                <button id="pickerConfirm" class="w-full py-3 bg-slate-700 text-slate-500 rounded font-bold text-sm cursor-not-allowed transition-colors uppercase tracking-wider" disabled>
                    SeÃ§imi Tamamla
                </button>
            </div>
        </div>
    </div>

    <div id="simModal" class="modal">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm m-4 border border-slate-600 shadow-2xl">
            <h3 class="text-xl font-bold gold-text mb-6 text-center tracking-widest">OTOMATÄ°K SÄ°MÃœLASYON</h3>
            <div class="mb-5">
                <label class="block text-slate-400 text-[10px] font-bold mb-2 uppercase tracking-wide">Oyun SayÄ±sÄ± (Max 20)</label>
                <input type="number" id="simCount" value="10" min="1" max="20" class="w-full bg-slate-800 border border-slate-600 text-yellow-400 rounded p-3 text-center font-mono text-lg focus:outline-none focus:border-yellow-500">
            </div>
            <div id="simProgress" class="hidden mb-5">
                <div class="flex justify-between text-xs text-slate-400 mb-2 font-mono"><span>Ä°LERLEME</span><span id="simProgressText" class="text-yellow-400">0/0</span></div>
                <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden border border-slate-700">
                    <div id="simProgressBar" class="bg-yellow-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 text-center animate-pulse">AI hesaplÄ±yor...</p>
            </div>
            <div id="simResults" class="hidden bg-slate-800/80 p-4 rounded-lg mb-5 text-sm font-mono border border-slate-600"></div>
            <div class="flex gap-3">
                <button onclick="closeSimModal()" class="flex-1 py-3 mt2-btn rounded font-bold text-xs">KAPAT</button>
                <button onclick="startSimulation()" id="startSimBtn" class="flex-1 py-3 mt2-btn-primary rounded font-bold text-xs">BAÅLAT</button>
            </div>
        </div>
    </div>

<script>
    // --- OYUN SABÄ°TLERÄ° ---
    const COLORS = ['y', 'b', 'r'];
    const ALL_SETS = generateSets();
    
    // --- STATE ---
    let state = { hand: [], deckCount: 24, score: 0, usedCards: [] };
    let onnxSession = null;
    let isSimulationRunning = false;
    let gameLoopTimeout = null;

    // --- UI EVENTS ---
    const mctsSlider = document.getElementById('mctsSlider');
    const mctsValueDisplay = document.getElementById('mctsValue');
    
    mctsSlider.oninput = function() {
        const val = parseInt(this.value);
        if(val === 0) mctsValueDisplay.innerText = "REFLEKS (0)";
        else if(val < 50) mctsValueDisplay.innerText = `HIZLI (${val})`;
        else mctsValueDisplay.innerText = `DERÄ°N (${val})`;
        mctsValueDisplay.style.color = val > 100 ? '#f56565' : '#ecc94b';
    }

    // --- SETUP ---
    function generateSets() {
        let sets = [];
        const get_id = (c, v) => c * 8 + (v - 1);
        for (let c=0; c<3; c++) {
            for (let v=1; v<=6; v++) sets.push({ ids: [get_id(c,v), get_id(c,v+1), get_id(c,v+2)].sort((a,b)=>a-b), type: 'Renk SÄ±ralÄ±', score: (v-1)*10+50 });
        }
        for (let v=1; v<=8; v++) sets.push({ ids: [get_id(0,v), get_id(1,v), get_id(2,v)].sort((a,b)=>a-b), type: 'AynÄ± SayÄ±', score: (v-1)*10+20 });
        const perms = [[0,1,2], [0,2,1], [1,0,2], [1,2,0], [2,0,1], [2,1,0]];
        for (let v=1; v<=6; v++) {
            for (let p of perms) {
                let ids = [get_id(p[0], v), get_id(p[1], v+1), get_id(p[2], v+2)].sort((a,b)=>a-b);
                sets.push({ ids: ids, type: 'FarklÄ± Renk Seri', score: (v-1)*10+10 });
            }
        }
        return sets;
    }

    async function initAI() {
        try {
            onnxSession = await ort.InferenceSession.create('./model.onnx');
            console.log("âœ… AI HazÄ±r!");
        } catch (e) {
            console.error(e);
            alert("âš ï¸ Model yÃ¼klenemedi! 'model.onnx' dosyasÄ±nÄ± kontrol et.");
        }
    }
    initAI();

    // --- OYUN YÃ–NETÄ°MÄ° ---
    function resetGameUI() {
        clearTimeout(gameLoopTimeout);
        state = { hand: [], deckCount: 24, score: 0, usedCards: [] };
        document.getElementById('aiPanel').classList.add('hidden');
        renderHand(); 
        const handDiv = document.getElementById('myHand');
        handDiv.innerHTML = `<button id="startGameBtn" onclick="openPicker(5)" class="mt2-btn-primary px-8 py-4 rounded-lg font-bold text-white shadow-xl animate-pulse tracking-widest">ğŸ¤š OYUNU BAÅLAT</button>`;
    }

    function nextTurn(drawCount) {
        if (isSimulationRunning) return; 
        if(state.deckCount > 0) openPicker(drawCount); 
        else checkEndGame();
    }

    // --- ASIL ZEKÃ‚ ---
    async function askAI(returnMove = false) {
        if (!onnxSession) return;
        
        const mctsSims = parseInt(document.getElementById('mctsSlider').value);

        if (!isSimulationRunning && !returnMove) {
            updateAIUI("HesaplanÄ±yor...", "Yapay zeka dÃ¼ÅŸÃ¼nÃ¼yor...", true);
            await new Promise(r => setTimeout(r, 20));
        }

        let bestAction = -1;
        if (mctsSims > 0) bestAction = await runClientMCTS(mctsSims);
        else bestAction = await runFastPolicy();

        if (returnMove) return bestAction;

        updateAIUI("Analiz Tamam", "En iyi hamle bulundu.", false);
        renderHand(); 

        const btn = document.getElementById('executeBtn');
        const detail = document.getElementById('aiDetails');

        if (bestAction < 24) {
            const c = getCardObj(bestAction);
            updateAIUI("KART AT", `Bu kartÄ± elden Ã§Ä±kar.`, false, `[${c.val} ${getColorEmoji(c.color)}]`);
            highlightCards([bestAction], 'discard');
            
            btn.onclick = () => {
                state.hand = state.hand.filter(x => x.id !== bestAction);
                document.getElementById('aiPanel').classList.add('hidden');
                renderHand();
                nextTurn(1); 
            };
        } else {
            const setIdx = bestAction - 24;
            const setInfo = ALL_SETS[setIdx];
            const cardsStr = setInfo.ids.map(id => {
                const c = getCardObj(id);
                return `${c.val}${getColorEmoji(c.color)}`;
            }).join(" ");
            
            updateAIUI("SET YAP", `${setInfo.type} (+${setInfo.score} Puan)`, false, `BirleÅŸtir: ${cardsStr}`);
            highlightCards(setInfo.ids, 'keep');
            
            btn.onclick = () => {
                state.score += setInfo.score;
                state.hand = state.hand.filter(x => !setInfo.ids.includes(x.id));
                document.getElementById('aiPanel').classList.add('hidden');
                renderHand();
                const drawNeed = Math.min(3, state.deckCount);
                if(drawNeed > 0) nextTurn(drawNeed);
                else checkEndGame(); 
            };
        }
    }

    function updateAIUI(title, desc, loading, details="") {
        const panel = document.getElementById('aiPanel');
        const tEl = document.getElementById('aiTitle');
        const dEl = document.getElementById('aiDesc');
        const detEl = document.getElementById('aiDetails');
        const btn = document.getElementById('executeBtn');

        panel.classList.remove('hidden');
        tEl.innerText = title;
        dEl.innerText = desc;
        detEl.innerText = details;

        if (loading) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            tEl.className = "text-sm font-bold text-slate-400 uppercase animate-pulse";
        } else {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            if(title.includes("AT")) tEl.className = "text-sm font-bold text-red-400 uppercase";
            else if(title.includes("SET")) tEl.className = "text-sm font-bold text-green-400 uppercase";
            else tEl.className = "text-sm font-bold text-yellow-400 uppercase";
        }
    }

    // --- MCTS OPTIMIZED ---
    async function runClientMCTS(simulations) {
        let validMoves = [];
        for(let i=0; i<24; i++) if(state.hand.some(c => c.id === i)) validMoves.push(i);
        ALL_SETS.forEach((s, i) => { if(s.ids.every(id => state.hand.some(c => c.id === id))) validMoves.push(24+i); });

        if (validMoves.length === 0) return -1;
        if (validMoves.length === 1) return validMoves[0];

        const tensor = createStateTensor(state);
        const results = await onnxSession.run({ input: tensor });
        const policy = results.policy.data;

        let moveScores = {};
        for (let move of validMoves) {
            let totalSimValue = 0;
            const simCountForMove = Math.max(2, Math.floor(simulations / validMoves.length));

            for(let k=0; k<simCountForMove; k++) {
                let simState = JSON.parse(JSON.stringify(state)); 
                let immediateScore = 0;
                
                if(move < 24) { 
                    simState.hand = simState.hand.filter(c => c.id !== move);
                    if(simState.deckCount > 0) simulateDraw(simState, 1);
                } else { 
                    let setInfo = ALL_SETS[move-24];
                    immediateScore = setInfo.score;
                    simState.score += immediateScore;
                    simState.hand = simState.hand.filter(c => !setInfo.ids.includes(c.id));
                    let draw = Math.min(3, simState.deckCount);
                    if(draw > 0) simulateDraw(simState, draw);
                }

                const t = createStateTensor(simState);
                const res = await onnxSession.run({ input: t });
                let v = res.value.data[0];
                let scoreImpact = immediateScore / 100.0; 
                totalSimValue += (v + scoreImpact);

                if (k % 20 === 0) await new Promise(r => setTimeout(r, 0));
            }
            
            let avgSim = totalSimValue / simCountForMove;
            let pVal = policy[move];
            moveScores[move] = (avgSim * 0.7) + (pVal * 0.3);
        }

        let bestM = validMoves[0];
        let maxS = -Infinity;
        for(let m of validMoves) { if(moveScores[m] > maxS) { maxS = moveScores[m]; bestM = m; } }
        return bestM;
    }

    async function runFastPolicy() {
        const tensor = createStateTensor(state);
        const results = await onnxSession.run({ input: tensor });
        const policy = results.policy.data;
        let bestAction = -1; let bestVal = -Infinity; const SET_BONUS_MULTIPLIER = 1.3; 

        for(let i=0; i<24; i++) { if(state.hand.some(c => c.id === i)) { if(policy[i] > bestVal) { bestVal = policy[i]; bestAction = i; } } }
        ALL_SETS.forEach((setInfo, idx) => {
            const actionIdx = 24 + idx;
            const hasAll = setInfo.ids.every(id => state.hand.some(c => c.id === id));
            if(hasAll) {
                let val = policy[actionIdx] * SET_BONUS_MULTIPLIER;
                if (state.score + setInfo.score >= 400 && state.score < 400) val *= 3.0;
                if(val > bestVal) { bestVal = val; bestAction = actionIdx; }
            }
        });
        return bestAction;
    }

    // --- YARDIMCILAR ---
    function simulateDraw(simState, count) {
        let available = [];
        for(let i=0; i<24; i++) if(!simState.usedCards.includes(i)) available.push(i);
        for (let i = available.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [available[i], available[j]] = [available[j], available[i]];
        }
        for(let k=0; k<count && k<available.length; k++) {
            let id = available[k];
            simState.hand.push({id: id, color: Math.floor(id/8), val: (id%8)+1});
            simState.usedCards.push(id);
        }
        simState.deckCount = Math.max(0, simState.deckCount - count);
    }

    function createStateTensor(inpState) {
        const data = new Float32Array(4 * 3 * 8).fill(0);
        inpState.hand.forEach(c => { const idx = 0*24 + c.color*8 + (c.val-1); data[idx] = 1.0; });
        const dN = inpState.deckCount / 24.0;
        for(let i=24; i<48; i++) data[i] = dN;
        const sN = Math.min(inpState.score, 600) / 600.0;
        for(let i=48; i<72; i++) data[i] = sN;
        for(let i=72; i<96; i++) data[i] = 1.0;
        return new ort.Tensor('float32', data, [1, 4, 3, 8]);
    }

    function getCardObj(id) { return { id: id, color: Math.floor(id / 8), val: (id % 8) + 1 }; }
    function getColorClass(c) { return ['y', 'b', 'r'][c]; }
    function getColorEmoji(c) { return ['ğŸ’›', 'ğŸ’™', 'â¤ï¸'][c]; }

    function renderHand() {
        if(isSimulationRunning) return;
        const div = document.getElementById('myHand');
        div.innerHTML = '';
        state.hand.sort((a,b)=>a.id-b.id).forEach(c => {
            const el = document.createElement('div');
            el.className = `card ${getColorClass(c.color)}`;
            el.innerText = c.val;
            el.dataset.id = c.id;
            div.appendChild(el);
        });
        document.getElementById('scoreDisplay').innerText = state.score;
        document.getElementById('deckDisplay').innerText = state.deckCount;
    }

    function highlightCards(targetIds, type) {
        if(isSimulationRunning) return;
        const allCards = document.querySelectorAll('.card');
        allCards.forEach(c => c.classList.remove('suggest-keep', 'suggest-discard', 'opacity-dim'));
        targetIds.forEach(id => {
            const el = document.querySelector(`.card[data-id="${id}"]`);
            if (el) {
                if (type === 'discard') el.classList.add('suggest-discard');
                else el.classList.add('suggest-keep');
            }
        });
        if (type === 'keep') {
            allCards.forEach(c => {
                if (!c.classList.contains('suggest-keep') && !c.classList.contains('suggest-discard')) c.classList.add('opacity-dim');
            });
        }
    }

    function canAnySetBeMade() {
        return ALL_SETS.some(setInfo => setInfo.ids.every(id => state.hand.some(c => c.id === id)));
    }

    let pickerSelection = [];
    let pickerTarget = 0;

    function drawRandomCards(count) {
        let availableIds = [];
        for(let i=0; i<24; i++) if(!state.usedCards.includes(i)) availableIds.push(i);
        availableIds.sort(() => Math.random() - 0.5);
        availableIds.slice(0, count).forEach(id => {
            state.hand.push(getCardObj(id));
            state.usedCards.push(id);
        });
        state.deckCount = Math.max(0, state.deckCount - count);
        if(!isSimulationRunning) {
            renderHand();
            gameLoopTimeout = setTimeout(askAI, 300);
        }
    }

    function openPicker(count) {
        const isAuto = document.getElementById('autoDrawToggle').checked;
        if(isAuto) { drawRandomCards(count); return; }

        pickerTarget = count;
        pickerSelection = [];
        const modal = document.getElementById('pickerModal');
        const grid = document.getElementById('pickerGrid');
        const title = document.getElementById('pickerTitle');
        
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);

        title.innerText = `${count} KART Ã‡EK`;
        grid.innerHTML = '';
        
        for(let i=0; i<24; i++) {
            const c = getCardObj(i);
            const isUnavailable = state.usedCards.includes(i);
            const el = document.createElement('div');
            el.className = `card ${getColorClass(c.color)} text-xs h-14 w-full`;
            el.innerText = c.val;
            
            if(isUnavailable) {
                el.classList.add('taken'); 
            } else {
                el.onclick = () => {
                    if(el.classList.contains('selected')) {
                        el.classList.remove('selected');
                        pickerSelection = pickerSelection.filter(x => x !== i);
                    } else if(pickerSelection.length < pickerTarget) {
                        el.classList.add('selected');
                        pickerSelection.push(i);
                    }
                    updatePickerBtn();
                };
            }
            grid.appendChild(el);
        }
        updatePickerBtn();
    }

    function closeModal(id) {
        const m = document.getElementById(id);
        m.classList.remove('show');
        setTimeout(() => m.style.display = 'none', 300);
    }

    function updatePickerBtn() {
        const btn = document.getElementById('pickerConfirm');
        btn.innerText = `SEÃ‡Ä°MÄ° TAMAMLA (${pickerSelection.length}/${pickerTarget})`;
        if(pickerSelection.length === pickerTarget) {
            btn.disabled = false;
            btn.classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
            btn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
            btn.onclick = () => {
                pickerSelection.forEach(id => {
                    state.hand.push(getCardObj(id));
                    state.usedCards.push(id); 
                });
                state.deckCount = Math.max(0, state.deckCount - pickerTarget);
                closeModal('pickerModal');
                renderHand();
                askAI(); 
            };
        } else {
            btn.disabled = true;
            btn.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
            btn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-500');
        }
    }

    // --- SÄ°MÃœLASYON ---
    function openSimModal() { 
        document.getElementById('simModal').style.display = 'flex'; 
        setTimeout(() => document.getElementById('simModal').classList.add('show'), 10);
    }
    function closeSimModal() { closeModal('simModal'); }

    async function startSimulation() {
        if (!onnxSession) { alert("Model hazÄ±r deÄŸil!"); return; }
        
        const count = parseInt(document.getElementById('simCount').value);
        if(count < 1 || count > 20) { alert("TarayÄ±cÄ± saÄŸlÄ±ÄŸÄ± iÃ§in 1-20 arasÄ± oyun seÃ§in."); return; }

        isSimulationRunning = true;
        document.getElementById('startSimBtn').disabled = true;
        document.getElementById('simProgress').classList.remove('hidden');
        document.getElementById('simResults').classList.add('hidden');

        let totalScore = 0;
        let silverCount = 0; 
        let goldCount = 0;   
        let bronzeCount = 0;

        for(let i=0; i<count; i++) {
            const pct = Math.round(((i) / count) * 100);
            document.getElementById('simProgressBar').style.width = `${pct}%`;
            document.getElementById('simProgressText').innerText = `${i+1}/${count}`;
            
            const gameScore = await playSingleGame();
            totalScore += gameScore;
            
            if(gameScore >= 400) goldCount++;
            else if(gameScore >= 300) silverCount++;
            else bronzeCount++; 
            
            await new Promise(r => setTimeout(r, 20));
        }

        isSimulationRunning = false;
        document.getElementById('simProgressBar').style.width = `100%`;
        document.getElementById('startSimBtn').disabled = false;
        
        const avg = (totalScore / count).toFixed(1);
        const resultsDiv = document.getElementById('simResults');
        resultsDiv.innerHTML = `
            <div class="flex justify-between border-b border-slate-600 pb-2 mb-2">
                <span class="text-slate-400">Oyun SayÄ±sÄ±</span> <span class="text-white font-bold">${count}</span>
            </div>
            <div class="flex justify-between border-b border-slate-600 pb-2 mb-2">
                <span class="text-slate-400">Ortalama Skor</span> <span class="text-yellow-400 font-bold text-lg">${avg}</span>
            </div>
            <div class="space-y-2 mt-3">
                <div class="flex justify-between items-center bg-yellow-900/20 p-2 rounded border border-yellow-700/30">
                    <span class="text-yellow-400 font-bold">âœ¨ ALTIN (400+)</span> 
                    <span class="text-white font-mono">${goldCount} (%${(goldCount/count*100).toFixed(0)})</span>
                </div>
                <div class="flex justify-between items-center bg-slate-700/30 p-2 rounded border border-slate-600/30">
                    <span class="text-slate-300 font-bold">â›“ï¸ GÃœMÃœÅ (300-399)</span> 
                    <span class="text-white font-mono">${silverCount} (%${(silverCount/count*100).toFixed(0)})</span>
                </div>
                <div class="flex justify-between items-center bg-orange-900/20 p-2 rounded border border-orange-700/30">
                    <span class="text-orange-400 font-bold">ğŸ“¦ BRONZ (<300)</span> 
                    <span class="text-white font-mono">${bronzeCount} (%${(bronzeCount/count*100).toFixed(0)})</span>
                </div>
            </div>
        `;
        resultsDiv.classList.remove('hidden');
    }

    async function playSingleGame() {
        let tempState = { hand: [], deckCount: 24, score: 0, usedCards: [] };
        
        function simDraw(cnt) {
            let av = [];
            for(let i=0; i<24; i++) if(!tempState.usedCards.includes(i)) av.push(i);
            av.sort(() => Math.random() - 0.5);
            av.slice(0, cnt).forEach(id => {
                tempState.hand.push({ id: id, color: Math.floor(id/8), val: (id%8)+1 });
                tempState.usedCards.push(id);
            });
            tempState.deckCount = Math.max(0, tempState.deckCount - cnt);
        }
        simDraw(5);

        let originalState = JSON.parse(JSON.stringify(state));
        state = tempState; 

        while(true) {
            if (state.hand.length === 0) break;
            const canSet = ALL_SETS.some(s => s.ids.every(id => state.hand.some(c => c.id === id)));
            if (state.deckCount === 0 && !canSet) break;

            const actionIdx = await askAI(true); 

            if (actionIdx < 24) {
                state.hand = state.hand.filter(x => x.id !== actionIdx);
                if(state.deckCount > 0) simDraw(1);
            } else {
                const setIdx = actionIdx - 24;
                const setInfo = ALL_SETS[setIdx];
                state.score += setInfo.score;
                state.hand = state.hand.filter(x => !setInfo.ids.includes(x.id));
                const drawNeed = Math.min(3, state.deckCount);
                if(drawNeed > 0) simDraw(drawNeed);
            }
        }
        
        const finalScore = state.score;
        state = originalState; 
        return finalScore;
    }

    function checkEndGame() {
        if (isSimulationRunning) return; 

        if(state.hand.length === 0) {
            finishGame("Elindeki kartlar bitti!");
            return;
        }
        if (state.deckCount === 0) {
            if (!canAnySetBeMade()) {
                finishGame("Deste bitti ve yapÄ±lacak hamle kalmadÄ±!");
                return;
            }
        }
        renderHand();
        gameLoopTimeout = setTimeout(askAI, 500); 
    }

    function finishGame(msg) {
        let sandik = "ğŸ“¦ BRONZ SANDIK";
        if(state.score >= 400) { sandik = "âœ¨ ALTIN SANDIK"; }
        else if(state.score >= 300) { sandik = "â›“ï¸ GÃœMÃœÅ SANDIK"; }
        
        alert(`OYUN BÄ°TTÄ°!\n${msg}\n\nğŸ† SKOR: ${state.score}\nKAZANÃ‡: ${sandik}`);
        resetGameUI(); // Oyunu ve durumu tamamen temizle
    }
</script>
</body>

</html>


