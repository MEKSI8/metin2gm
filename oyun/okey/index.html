<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Okey Oyna - Metin2 Okey Botu | Metin2GM</title>
    <meta name="description" content="Metin2 Okey oyununu sim√ºle edin ve en iyi hamleleri √∂ƒürenin.">
    <meta name="robots" content="noindex, follow">
    
    <!-- FAVICON -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9956375486231442"
     crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; touch-action: manipulation; }
        
        .ad-placeholder { width: 100%; height: 60px; background-color: #1e293b; border: 1px dashed #475569; display: flex; justify-content: center; align-items: center; color: #64748b; font-size: 0.75rem; border-radius: 8px; margin: 0 auto; overflow: hidden; }
        @media (min-width: 768px) { .ad-placeholder { height: 90px; } }

        /* Kart Stilleri */
        .card { 
            width: 100%; aspect-ratio: 2/3; min-width: 0; border-radius: 6px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-weight: 900; font-size: clamp(0.8rem, 3.5vw, 1.4rem); 
            cursor: pointer; position: relative; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.15); 
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; 
            background: linear-gradient(135deg, #334155, #1e293b); 
        }
        .card.red { background: linear-gradient(145deg, #dc2626, #7f1d1d); color: #fecaca; border-color: #ef4444; }
        .card.yellow { background: linear-gradient(145deg, #ca8a04, #713f12); color: #fef08a; border-color: #eab308; }
        .card.blue { background: linear-gradient(145deg, #2563eb, #1e3a8a); color: #bfdbfe; border-color: #3b82f6; }
        
        .card:active { transform: scale(0.95); }
        
        .card.selected-in-modal { 
            transform: translateY(-4px) scale(1.05); 
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.9); 
            border: 2px solid #60a5fa; 
            z-index: 20; 
        }
        .card.selected-in-modal::after { 
            content: '‚úì'; position: absolute; top: -5px; right: -5px; 
            background: #2563eb; color: white; border-radius: 50%; 
            width: 18px; height: 18px; font-size: 11px; 
            display: flex; justify-content: center; align-items: center; 
            border: 2px solid white; 
        }
        
        .card.taken { opacity: 0.2; filter: grayscale(100%); cursor: not-allowed; border: 1px dashed #475569; background: #0f172a; }
        
        .suggest-discard { border: 3px solid #ef4444 !important; transform: translateY(-10px); box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        .suggest-keep { border: 3px solid #22c55e !important; transform: translateY(-10px); box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
        .opacity-dim { opacity: 0.2; pointer-events: none; filter: blur(1px); }

        .hand-grid { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
        .hand-grid .card { width: 55px; height: 80px; font-size: 1.3rem; }
        
        /* Deste Grid - Her zaman 8 s√ºtun */
        .deck-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; padding: 2px; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 50; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .modal.active { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- √úst Navigasyon -->
    <header class="bg-slate-900 border-b border-slate-700 p-3 sticky top-0 z-30 shadow-xl flex justify-between items-center max-w-3xl mx-auto w-full">
        <a href="/" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors group">
            <div class="bg-slate-800 p-1.5 rounded group-hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
            </div>
            <span class="text-xs font-bold uppercase tracking-wider hidden sm:block">Ana Sayfa</span>
        </a>
        <div class="flex gap-2 text-center">
            <div class="bg-slate-800 px-3 py-1 rounded border border-slate-700 min-w-[70px]">
                <div class="text-[9px] text-slate-400 font-bold uppercase">Skor</div>
                <div class="text-lg font-mono text-white leading-none" id="totalScore">0</div>
            </div>
            <div class="bg-slate-800 px-3 py-1 rounded border border-slate-700 min-w-[70px]">
                <div class="text-[9px] text-slate-400 font-bold uppercase">Kalan</div>
                <div class="text-lg font-mono text-blue-400 leading-none" id="deckCount">24</div>
            </div>
        </div>
    </header>

    <!-- [REKLAM ALANI 1] -->
    <div class="w-full px-2 pt-2 flex justify-center">
        <div class="ad-placeholder max-w-3xl">REKLAM ALANI (Oyun √úst√º)</div>
    </div>

    <main class="flex-grow p-3 flex flex-col items-center justify-start gap-4 max-w-3xl mx-auto w-full">
        
        <!-- Yapay Zeka Paneli -->
        <div id="aiPanel" class="w-full bg-gradient-to-br from-slate-900 to-slate-800 border border-slate-700 rounded-xl p-4 shadow-2xl hidden transform transition-all">
            <div class="flex items-start gap-3">
                <div class="text-3xl animate-bounce" id="aiIcon">ü§ñ</div>
                <div class="flex-1">
                    <h2 class="text-lg font-bold text-white leading-tight" id="aiTitle">Analiz...</h2>
                    <p class="text-xs text-slate-300 mt-1 leading-relaxed" id="aiText">Hesaplanƒ±yor.</p>
                </div>
            </div>
            <button id="executeBtn" class="mt-3 w-full py-3 rounded-lg font-bold text-white shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                HAMLEYƒ∞ UYGULA
            </button>
        </div>

        <!-- Kullanƒ±cƒ±nƒ±n Eli -->
        <div class="w-full">
            <div class="flex justify-between items-end mb-2 px-1">
                <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Mevcut Eliniz</h3>
                <button id="undoBtn" onclick="undoLastMove()" class="text-xs text-red-400 hover:text-red-300 font-bold flex items-center gap-1 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    GERƒ∞ AL
                </button>
            </div>
            
            <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-4 min-h-[120px] flex justify-center items-center relative shadow-inner">
                <div class="hand-grid w-full justify-center" id="myHand">
                    <button onclick="startHandSelection()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-bold shadow-lg shadow-blue-500/20 animate-pulse transition-all text-sm">
                        ‚úã Oyunu Ba≈ülat (5 Kart Se√ß)
                    </button>
                </div>
            </div>
        </div>

        <!-- [REKLAM ALANI 2] -->
        <div class="w-full"><div class="ad-placeholder">REKLAM ALANI (Oyun Altƒ±)</div></div>

        <button onclick="if(confirm('Oyunu sƒ±fƒ±rlamak istiyor musunuz?')) window.location.reload()" class="text-[10px] text-slate-600 hover:text-slate-400 uppercase tracking-widest mt-auto mb-2 p-2">
            [ Sƒ∞STEMƒ∞ SIFIRLA ]
        </button>
    </main>

    <!-- Kart Se√ßim Modalƒ± -->
    <div id="cardPickerModal" class="modal backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-xl p-4 w-full max-w-md m-4 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-3 border-b border-slate-800 pb-2">
                <div>
                    <h3 class="text-lg text-white font-bold" id="modalTitle">Kart Se√ßimi</h3>
                    <p class="text-xs text-slate-400" id="modalSubtext">Desteden geleni i≈üaretle.</p>
                </div>
                <button onclick="clearPickerSelection()" class="text-xs text-red-400 hover:text-white border border-red-900 bg-red-900/20 px-2 py-1 rounded">Temizle</button>
            </div>
            
            <div class="overflow-y-auto p-1 flex-grow">
                <div class="deck-grid" id="pickerGrid">
                    <!-- Kartlar JS ile dolacak -->
                </div>
            </div>

            <div class="mt-3 pt-2">
                <button id="modalConfirmBtn" class="w-full py-3 bg-slate-700 text-slate-500 rounded-lg font-bold text-sm cursor-not-allowed transition-all" disabled>
                    Se√ßimi Tamamla (0/0)
                </button>
            </div>
        </div>
    </div>

    <!-- Sonu√ß Modalƒ± -->
    <div id="resultModal" class="modal">
        <div class="bg-slate-900 border-2 border-yellow-500/30 rounded-xl p-8 max-w-xs w-full text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/10 to-transparent"></div>
            <div class="relative z-10">
                <div class="text-5xl mb-4 animate-bounce">üèÜ</div>
                <h2 class="text-2xl font-black text-white mb-2 tracking-tight">OYUN Bƒ∞TTƒ∞</h2>
                <div class="text-xs text-slate-400 mb-4 uppercase tracking-widest">TOPLAM SKOR</div>
                <div class="text-5xl font-mono font-bold text-yellow-400 mb-6" id="finalScore">0</div>
                <div id="rewardText" class="text-lg font-bold mb-6 py-2 px-4 rounded-lg bg-white/10 inline-block border border-white/10"></div>
                <button onclick="window.location.reload()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow-lg transition-all">
                    YENƒ∞ OYUN
                </button>
            </div>
        </div>
    </div>

<script>
// --- EN ƒ∞Yƒ∞ PARAMETRELER (TRADER FINAL) ---
const AI_PARAMS = { 
    RISK_BIAS_SILVER: 46, 
    RISK_BIAS_NORMAL: 26, 
    THRESHOLD_BASE: 40, 
    THRESHOLD_LOW: 0, 
    ALWAYS_TAKE_SCORE: 30, 
    PANIC_TRIGGER: 12, 
    EARLY_GAME_LIMIT: 8, 
    DISCARD_AGRESSION: 131, 
    DISCARD_COST: 37, 
    PAIR_WEIGHT: 7, 
    SERIES_WEIGHT: 21, 
    GAP_WEIGHT: 10 
};

const COLORS = { r: 'red', y: 'yellow', b: 'blue' };
const EMOJIS = { r: '‚ù§Ô∏è', y: 'üíõ', b: 'üíô' };
let FULL_DECK = []; ['r','y','b'].forEach(c=>{for(let i=1;i<=8;i++)FULL_DECK.push({id:c+i,color:c,val:i})});

// State ve Ge√ßmi≈ü (Undo i√ßin)
let state = { hand: [], deckRemaining: [...FULL_DECK], totalScore: 0, suggestion: null, tempSelection: [] };
let historyStack = [];

function saveState() {
    // Derin kopya ile ge√ßmi≈üi kaydet
    historyStack.push(JSON.parse(JSON.stringify({
        hand: state.hand,
        deckRemaining: state.deckRemaining,
        totalScore: state.totalScore
    })));
    // Maksimum 5 hamle geri alma
    if(historyStack.length > 5) historyStack.shift();
    updateUndoButton();
}

function undoLastMove() {
    if(historyStack.length === 0) return;
    const lastState = historyStack.pop();
    state.hand = lastState.hand;
    state.deckRemaining = lastState.deckRemaining;
    state.totalScore = lastState.totalScore;
    state.suggestion = null; // √ñneriyi sƒ±fƒ±rla, tekrar hesaplasƒ±n
    
    updateUndoButton();
    updateUI(analyzeMove());
}

function updateUndoButton() {
    const btn = document.getElementById('undoBtn');
    if(historyStack.length > 0) btn.classList.remove('hidden');
    else btn.classList.add('hidden');
}

// --- OYUN MANTIƒûI ---
function evaluateHandScore(cards) {
    if(cards.length!==3) return 0;
    const s = [...cards].sort((a,b)=>a.val-b.val);
    const [c1,c2,c3] = s;
    if(c1.val===c2.val && c2.val===c3.val) return (c1.val-1)*10+20;
    if(!((c1.val+1===c2.val)&&(c2.val+1===c3.val))) return 0;
    if(c1.color===c2.color && c2.color===c3.color) return (c1.val-1)*10+50;
    return (c1.val-1)*10+10;
}

function getBestSet(hand) {
    let best = {s:0, c:[]};
    for(let i=0;i<hand.length;i++) for(let j=i+1;j<hand.length;j++) for(let k=j+1;k<hand.length;k++) {
        const sub = [hand[i],hand[j],hand[k]]; const sc = evaluateHandScore(sub); if(sc>best.s) best = {s:sc,c:sub};
    } return best;
}

function calculateHandPotential(hand) {
    let pot = 0;
    for(let i=0;i<hand.length;i++) for(let j=i+1;j<hand.length;j++) {
        const c1=hand[i], c2=hand[j];
        if(c1.val===c2.val) pot+=AI_PARAMS.PAIR_WEIGHT;
        else if(c1.color===c2.color) { const d=Math.abs(c1.val-c2.val); if(d===1) pot+=AI_PARAMS.SERIES_WEIGHT; else if(d===2) pot+=AI_PARAMS.GAP_WEIGHT; }
    } return pot;
}

function analyzeMove() {
    const hand=state.hand, deck=state.deckRemaining, bestSet=getBestSet(hand);
    let threshold=AI_PARAMS.THRESHOLD_BASE;
    if(state.totalScore>=400) threshold=0;
    else if(deck.length>AI_PARAMS.EARLY_GAME_LIMIT) threshold=AI_PARAMS.THRESHOLD_BASE;
    else if(state.totalScore<300) { threshold=AI_PARAMS.THRESHOLD_LOW; if(deck.length<=AI_PARAMS.PANIC_TRIGGER) threshold=0; }
    else if(deck.length<5) threshold=0;

    let shouldCombine=false;
    if(bestSet.s>0) { if(bestSet.s>=threshold) shouldCombine=true; else if(deck.length<=3) shouldCombine=true; else if(bestSet.s>=AI_PARAMS.ALWAYS_TAKE_SCORE) shouldCombine=true; }

    let bestDiscardIdx=0, maxTotalVal=-Infinity;
    const sampleSize=Math.min(10, deck.length);
    const samples=deck.length>0 ? Array.from({length:sampleSize},()=>deck[Math.floor(Math.random()*deck.length)]) : [];

    for(let i=0;i<hand.length;i++) {
        const tempHand=hand.filter((_,idx)=>idx!==i);
        let mcEV=0;
        if(samples.length===0) mcEV=getBestSet(tempHand).s;
        else { let total=0; for(let c of samples) total+=getBestSet([...tempHand,c]).s; mcEV=total/sampleSize; }
        const pot=calculateHandPotential(tempHand);
        const totalVal=(mcEV*(AI_PARAMS.DISCARD_AGRESSION/100.0))+pot-AI_PARAMS.DISCARD_COST;
        if(totalVal>maxTotalVal) { maxTotalVal=totalVal; bestDiscardIdx=i; }
    }
    const bias=(state.totalScore<300) ? AI_PARAMS.RISK_BIAS_SILVER : AI_PARAMS.RISK_BIAS_NORMAL;
    if(!shouldCombine && bestSet.s>0) if((maxTotalVal-bestSet.s)<bias) shouldCombine=true;
    return shouldCombine ? {type:'COMBINE', score:bestSet.s, cards:bestSet.c} : {type:'DISCARD', score:0, cards:[hand[bestDiscardIdx]]};
}

// --- UI ---
function updateUI(move) {
    const p=document.getElementById('aiPanel'), t=document.getElementById('aiTitle'), txt=document.getElementById('aiText'), btn=document.getElementById('executeBtn'), ico=document.getElementById('aiIcon');
    p.classList.remove('hidden'); state.suggestion=move;
    if(move.type==='COMBINE') {
        ico.innerText="üí∞"; t.innerText=`SET: ${move.score} PUAN`; t.className="text-lg font-bold text-green-400 mb-1";
        txt.innerText="Puanƒ± al, risk yapma.";
        btn.className="mt-3 w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-white shadow-lg flex items-center justify-center gap-2"; btn.innerText="Bƒ∞RLE≈ûTƒ∞R";
    } else {
        const c=move.cards[0]; ico.innerText="üóëÔ∏è"; t.innerText=`AT: ${c.val} ${EMOJIS[c.color]}`; t.className="text-lg font-bold text-red-400 mb-1";
        txt.innerText="Bu kartƒ± elden √ßƒ±kar.";
        btn.className="mt-3 w-full py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-white shadow-lg flex items-center justify-center gap-2"; btn.innerText="KARTI AT";
    } renderHand();
}

function renderHand() {
    const div=document.getElementById('myHand'); div.innerHTML='';
    state.hand.forEach(c=>{
        const el=document.createElement('div'); el.className=`card ${COLORS[c.color]}`; el.innerHTML=`${c.val} <span class="text-[10px] absolute top-1 right-1 opacity-50">${EMOJIS[c.color]}</span>`;
        if(state.suggestion) {
            const isTarget=state.suggestion.cards.some(x=>x.id===c.id);
            if(isTarget) state.suggestion.type==='COMBINE' ? el.classList.add('suggest-keep') : el.classList.add('suggest-discard');
            else if(state.suggestion.type==='COMBINE') el.classList.add('opacity-dim');
        } div.appendChild(el);
    });
    document.getElementById('totalScore').innerText=state.totalScore; document.getElementById('deckCount').innerText=state.deckRemaining.length;
}

// --- PICKER ---
function renderPicker(cnt, cb) {
    const m=document.getElementById('cardPickerModal'), g=document.getElementById('pickerGrid'), t=document.getElementById('modalTitle'), b=document.getElementById('modalConfirmBtn');
    g.innerHTML=''; state.tempSelection=[]; t.innerText=`${cnt} Kart Se√ßiniz`; updateConfirmButton(cnt);
    FULL_DECK.forEach(c=>{
        const isAv=state.deckRemaining.some(r=>r.id===c.id); const el=document.createElement('div'); el.className=`card ${COLORS[c.color]}`; el.innerHTML=`${c.val} <span class="text-[10px] absolute top-1 right-1 opacity-50">${EMOJIS[c.color]}</span>`;
        if(!isAv) el.classList.add('taken');
        else el.onclick=()=>{
            if(state.tempSelection.includes(c)) { state.tempSelection=state.tempSelection.filter(x=>x!==c); el.classList.remove('selected-in-modal'); }
            else if(state.tempSelection.length<cnt) { state.tempSelection.push(c); el.classList.add('selected-in-modal'); }
            updateConfirmButton(cnt);
        }; g.appendChild(el);
    });
    b.onclick=()=>{ if(state.tempSelection.length===cnt) { m.classList.remove('active'); cb(state.tempSelection); } }; m.classList.add('active');
}

function updateConfirmButton(cnt) {
    const b=document.getElementById('modalConfirmBtn'), curr=state.tempSelection.length; b.innerText=`Se√ßimi Tamamla (${curr}/${cnt})`;
    if(curr===cnt) { b.classList.replace('bg-slate-700','bg-blue-600'); b.classList.replace('text-slate-500','text-white'); b.classList.remove('cursor-not-allowed'); b.disabled=false; }
    else { b.classList.replace('bg-blue-600','bg-slate-700'); b.classList.replace('text-white','text-slate-500'); b.classList.add('cursor-not-allowed'); b.disabled=true; }
}

function clearPickerSelection() {
    state.tempSelection = [];
    document.querySelectorAll('.selected-in-modal').forEach(el => el.classList.remove('selected-in-modal'));
    // Hedef sayƒ±sƒ±nƒ± buton textinden bul (kirli ama hƒ±zlƒ± √ß√∂z√ºm)
    const btnText = document.getElementById('modalConfirmBtn').innerText;
    const target = parseInt(btnText.split('/')[1]); 
    updateConfirmButton(target);
}

function startHandSelection() {
    saveState(); // Ba≈ülamadan kaydet
    renderPicker(5, (c)=>{ state.hand=c; state.deckRemaining=state.deckRemaining.filter(x=>!c.includes(x)); document.getElementById('myHand').innerHTML=''; updateUI(analyzeMove()); }); 
}

document.getElementById('executeBtn').onclick=()=>{
    saveState(); // Hamle √∂ncesi kaydet
    const m=state.suggestion; if(!m) return;
    if(m.type==='COMBINE') { state.totalScore+=m.score; const ids=m.cards.map(x=>x.id); state.hand=state.hand.filter(x=>!ids.includes(x.id));
        const need=Math.min(3,state.deckRemaining.length); if(need>0) renderPicker(need,(nc)=>{ state.hand.push(...nc); state.deckRemaining=state.deckRemaining.filter(x=>!nc.includes(x)); updateUI(analyzeMove()); }); else endGame();
    } else { const rm=m.cards[0]; state.hand=state.hand.filter(x=>x.id!==rm.id);
        if(state.deckRemaining.length>0) renderPicker(1,(nc)=>{ state.hand.push(...nc); state.deckRemaining=state.deckRemaining.filter(x=>!nc.includes(x)); updateUI(analyzeMove()); }); else endGame();
    }
}

function endGame() {
    document.getElementById('resultModal').classList.add('active'); document.getElementById('finalScore').innerText=state.totalScore;
    let t="BRONZ SANDIK üì¶", s="text-orange-400 border-orange-500";
    if(state.totalScore>=400) { t="ALTIN SANDIK ‚ú®"; s="text-yellow-400 border-yellow-500"; }
    else if(state.totalScore>=300) { t="G√úM√ú≈û SANDIK ‚õìÔ∏è"; s="text-slate-300 border-slate-400"; }
    const r=document.getElementById('rewardText'); r.innerText=t; r.className=`text-xl font-bold mb-8 py-2 px-6 rounded-lg bg-white/10 inline-block border ${s}`;
}
</script>
</body>

</html>
